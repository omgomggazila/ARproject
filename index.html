<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARç”Ÿæ…‹æ¢éšªï¼šç’°å¢ƒä¿è‚²æ•™è‚²æ¡ŒéŠç³»çµ±</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; background-color: #000; user-select: none; }
        
        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
        .btn { border: none; border-radius: 50px; cursor: pointer; transition: 0.2s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.95); }

        /* --- 1. é¦–é èˆ‡é¸é‚Š UI --- */
        #home-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #141E30 0%, #243B55 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; color: white; text-align: center;
        }
        
        #team-select-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2100;
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }

        .team-btn { width: 200px; padding: 20px; margin: 15px; font-size: 24px; color: white; }
        .btn-blue { background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%); border: 2px solid #89a5e6; }
        .btn-red { background: linear-gradient(90deg, #D31027 0%, #EA384D 100%); border: 2px solid #ff8a95; }

        /* --- 1.1 éŠæˆ²èªªæ˜å½ˆçª— --- */
        #instruction-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 450px; background: white; color: #333;
            padding: 25px; border-radius: 15px; display: none; z-index: 3000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left;
        }
        #instruction-modal h3 { text-align: center; color: #2c3e50; margin-top: 0; }
        #instruction-modal p { line-height: 1.8; font-size: 16px; }

        /* --- 2. éŠæˆ²ä¸­ UI (åˆ†æ•¸èˆ‡å›åˆ) --- */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 1000; }
        
        /* åˆ†æ•¸æ¿ */
        .score-board {
            position: absolute; top: 15px; padding: 10px 20px; border-radius: 10px;
            color: white; font-size: 18px; font-weight: bold;
            display: flex; flex-direction: column; align-items: center;
        }
        #score-blue-box { left: 15px; background: rgba(20, 50, 100, 0.8); border-left: 5px solid #4b6cb7; }
        #score-red-box { right: 15px; background: rgba(100, 20, 20, 0.8); border-right: 5px solid #D31027; }
        .big-score { font-size: 28px; }

        /* å›åˆæ©«å¹…å‹•ç•« */
        #turn-banner {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            padding: 10px 40px; border-radius: 30px;
            font-size: 20px; color: white; font-weight: bold;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            transition: background 0.5s, border 0.5s;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } 100% { transform: translateX(-50%) scale(1); } }

        /* --- 2.1 æ–°å¢æ§åˆ¶é¢æ¿ (æ›äººèˆ‡å¤©æ“‡æŒ‰éˆ•) --- */
        #control-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; pointer-events: auto;
        }
        .ctrl-btn {
            padding: 12px 25px; font-size: 18px; color: white; border-radius: 30px;
            border: 2px solid rgba(255,255,255,0.5); backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 8px;
        }
        /* æ›äººæŒ‰éˆ• */
        #btn-switch { background: rgba(0, 0, 0, 0.6); }
        #btn-switch:hover { background: rgba(0, 0, 0, 0.8); }
        
        /* å¤©æ“‡æŒ‰éˆ• */
        #btn-natural { background: rgba(80, 80, 80, 0.6); transition: 0.3s; }
        #btn-natural.active { 
            background: linear-gradient(45deg, #FF512F, #DD2476); 
            border-color: #FFD700; box-shadow: 0 0 15px #FF512F;
            animation: shake 0.5s;
        }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }

        /* --- 3. æƒææˆåŠŸå¤§å­—å¡ --- */
        #theme-toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85); color: #FFD700;
            padding: 30px 50px; border-radius: 20px; border: 3px solid #FFD700;
            font-size: 40px; font-weight: bold; text-shadow: 0 0 10px orange;
            display: none; z-index: 1500; white-space: nowrap;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }

        /* --- 4. é¡Œç›®èˆ‡çµç®— UI --- */
        #quiz-box { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 1600; background: white; padding: 25px; border-radius: 20px; 
            display: none; width: 90%; max-width: 400px; text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); pointer-events: auto;
        }
        .option-btn {
            display: block; width: 100%; margin: 10px 0; padding: 12px;
            background: #f0f0f0; border: 2px solid #ddd; border-radius: 10px;
            font-size: 16px; cursor: pointer; text-align: left;
        }
        .option-btn:hover { background: #e0e0e0; }

        #result-msg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); color: white; display: none; 
            z-index: 1700; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; padding: 20px; pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="home-screen">
    <h1 style="font-size: 2.8em; text-shadow: 0 0 20px rgba(0,255,255,0.5);">AR ç”Ÿæ…‹æ¢éšª</h1>
    <p style="opacity: 0.8; margin-bottom: 30px;">ç´…è—å°æŠ—ãƒ»ç’°å¢ƒä¿è‚²æ¡ŒéŠ</p>
    <button class="btn" onclick="toggleInstructions(true)" style="background: #FF9800; color: white; padding: 12px 40px; font-size: 18px; margin-bottom: 20px;">
        ğŸ“– éŠæˆ²èªªæ˜
    </button>
    <button id="init-btn" class="btn" style="padding: 15px 50px; font-size: 22px; background: white; color: #333;" disabled>
        ç³»çµ±è¼‰å…¥ä¸­...
    </button>
</div>

<div id="instruction-modal">
    <h3>ğŸ“– éŠæˆ²èªªæ˜</h3>
    <hr style="border: 0; border-top: 1px solid #eee;">
    <p>
        1. <b>åˆ†çµ„å°æŠ—</b>ï¼šåˆ†ç‚ºè—æ–¹èˆ‡ç´…æ–¹ï¼Œé›™æ–¹è¼ªæµæŠ½å¡æƒæã€‚<br>
        2. <b>å¡ç‰Œä»»å‹™</b>ï¼š<br>
           - æƒæ<b>ç ´å£å¡</b>ï¼šç­”å°æ‰£æ•µæ–¹åˆ†æ•¸ï¼Œç­”éŒ¯æ‰£è‡ªå·±ã€‚<br>
           - æƒæ<b>ä¿è‚²å¡</b>ï¼šç­”å°åŠ è‡ªå·±åˆ†æ•¸ã€‚<br>
        3. <b>ç‰¹æ®ŠåŠŸèƒ½</b>ï¼š<br>
           - <b>âš¡ å¤©æ“‡æ¨¡å¼</b>ï¼šé–‹å•Ÿå¾Œï¼Œä»»ä½•å¡ç‰‡éƒ½è¦–ç‚ºã€Œç ´å£å¡ã€ï¼Œä¸”åˆ†æ•¸è®Š 2 å€ï¼ˆé«˜é¢¨éšªé«˜å ±é…¬ï¼‰ã€‚<br>
        4. <b>ç²å‹æ¢ä»¶</b>ï¼š<br>
           ğŸ† ç‡å…ˆç´¯ç©é”åˆ° <b>50 åˆ†</b> çš„éšŠä¼ç²å‹ï¼
    </p>
    <button class="btn" onclick="toggleInstructions(false)" style="background: #2c3e50; color: white; width: 100%; padding: 12px;">æˆ‘çŸ¥é“äº†</button>
</div>

<div id="team-select-modal">
    <h2>èª°å…ˆé–‹å§‹ï¼Ÿ</h2>
    <p>è«‹æ“²éª°å­æˆ–çŒœæ‹³æ±ºå®šå…ˆæ‰‹</p>
    <button class="btn team-btn btn-blue" onclick="startGame('blue')">è—æ–¹å…ˆæ”»</button>
    <button class="btn team-btn btn-red" onclick="startGame('red')">ç´…æ–¹å…ˆæ”»</button>
</div>

<div id="ui-layer">
    <div id="score-blue-box" class="score-board">
        <span>è—æ–¹ (BLUE)</span>
        <span id="score-blue" class="big-score">0</span>
    </div>
    <div id="score-red-box" class="score-board">
        <span>ç´…æ–¹ (RED)</span>
        <span id="score-red" class="big-score">0</span>
    </div>
    
    <div id="turn-banner">æº–å‚™é–‹å§‹...</div>

    <div id="control-panel">
        <button id="btn-switch" class="btn ctrl-btn" onclick="manualNextTurn()">
            ğŸ”„ å¼·åˆ¶æ›äºº
        </button>
        <button id="btn-natural" class="btn ctrl-btn" onclick="toggleNaturalSelection()">
            âš¡ å¤©æ“‡æ¨¡å¼ <span id="ns-status" style="font-size:12px; margin-left:5px;">OFF</span>
        </button>
    </div>
</div>

<div id="theme-toast">ä¸»é¡Œåç¨±</div>

<div id="quiz-box">
    <h3 id="q-category" style="color: #666; font-size: 14px; margin:0;">åˆ†é¡</h3>
    <h2 id="q-title" style="color: #333; margin: 5px 0 15px 0;">ä¸»é¡Œ</h2>
    <p id="q-text" style="font-size: 18px; font-weight: bold; line-height: 1.5; text-align: left;">é¡Œç›®è¼‰å…¥ä¸­...</p>
    <div id="q-options"></div>
</div>

<div id="result-msg">
    <h1 id="res-title" style="font-size: 60px; margin: 0;"></h1>
    <h3 id="res-score" style="color: yellow;"></h3>
    <p id="res-detail" style="font-size: 18px; margin-top: 20px; max-width: 80%; line-height: 1.6;"></p>
    <button id="res-btn" class="btn" style="background: white; color: black; padding: 15px 40px; margin-top: 30px;" onclick="nextTurn()">
        æ›å°æ–¹å›åˆ
    </button>
</div>

<a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; filterMinCF:0.001; filterBeta:0.01;" 
         color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
         vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    
    <a-assets>
        <video id="v0" src="./videos/v0.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v1" src="./videos/v1.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v2" src="./videos/v2.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v3" src="./videos/v3.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v4" src="./videos/v4.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v5" src="./videos/v5.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v6" src="./videos/v6.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v7" src="./videos/v7.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v8" src="./videos/v8.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v9" src="./videos/v9.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <script>
        const scene = document.querySelector('a-scene');
        for (let i = 0; i < 10; i++) {
            const target = document.createElement('a-entity');
            target.setAttribute('mindar-image-target', `targetIndex: ${i}`);
            target.id = `marker${i}`;
            const vp = document.createElement('a-video');
            vp.setAttribute('src', `#v${i}`);
            vp.setAttribute('width', '1');
            vp.setAttribute('height', '0.75');
            target.appendChild(vp);
            scene.appendChild(target);
        }
    </script>
</a-scene>

<script>
    // --- éŠæˆ²è®Šæ•¸ ---
    let scores = { blue: 0, red: 0 };
    let currentTurn = ''; 
    let isLocked = false; 
    let isGameOver = false;
    let isNaturalSelection = false; // å¤©æ“‡æ¨¡å¼é–‹é—œ

    const quizDatabase = [
        { name: "éåº¦æ•æ’ˆ", type: "D", used: [], q: [{ t: "å“ªç¨®æ•é­šæ–¹å¼æœ€å®¹æ˜“ç ´å£æµ·åº•æ£²åœ°ï¼Ÿ", o: ["åº•æ‹–ç¶²", "ä¸€æ”¯é‡£", "å®šç½®ç¶²", "å‚é‡£"], a: 0 }, { t: "ã€Œæ··ç²ã€æ˜¯æŒ‡ä»€éº¼ï¼Ÿ", o: ["æ„å¤–æ•ç²éç›®æ¨™ç‰©ç¨®", "æ··åˆå¤šç¨®é­šé¡è²©è³£", "ä½¿ç”¨æ··åˆé¤Œæ–™", "æ··æ°´æ‘¸é­š"], a: 0 }, { t: "ç‚ºäº†æ°¸çºŒæµ·æ´‹ï¼Œæˆ‘å€‘æ‡‰è©²é¿å…è³¼è²·ï¼Ÿ", o: ["ç€•å±é­šç¨®", "é¤Šæ®–å³éƒ­é­š", "å¸¸è¦‹çš„ç§‹åˆ€é­š", "è›¤èœŠ"], a: 0 }, { t: "å¤§é‡æ•æ’ˆå°å‹é­šé¡æœƒé€ æˆä»€éº¼å¾Œæœï¼Ÿ", o: ["å¤§å‹é­šé¡é£Ÿç‰©çŸ­ç¼º", "æµ·æ°´è®Šé¹¹", "æµ·è—»æ¸›å°‘", "çŠç‘šç™½åŒ–"], a: 0 }, { t: "ä»¥ä¸‹ä½•è€…æ˜¯æ°¸çºŒæµ·é®®çš„åŸå‰‡ï¼Ÿ", o: ["åº•é£ŸåŸå‰‡(åƒåº•å±¤ç”Ÿç‰©)", "åªåƒé­šç¿…", "å°ˆæŒ‘ç¨€æœ‰é­š", "é£Ÿç”¨æœªæˆç†Ÿå¹¼é­š"], a: 0 }] },
        { name: "æ¿«ç æ¿«ä¼", type: "D", used: [], q: [{ t: "æ£®æ—ç ä¼æœƒç›´æ¥å°è‡´å“ªç¨®æ°£é«”å¢åŠ ï¼Ÿ", o: ["äºŒæ°§åŒ–ç¢³", "æ°§æ°£", "æ°®æ°£", "æ°«æ°£"], a: 0 }, { t: "æ¨¹æœ¨æ ¹éƒ¨çš„ä¸»è¦åŠŸèƒ½ä¸åŒ…å«ï¼Ÿ", o: ["å¸å¼•é›·é›»", "æŠ“ç·ŠåœŸå£¤", "å¸æ”¶æ°´åˆ†", "é˜²æ­¢åœŸçŸ³æµ"], a: 0 }, { t: "é›¨æ—è¢«ç¨±ç‚ºåœ°çƒçš„ä»€éº¼ï¼Ÿ", o: ["åœ°çƒä¹‹è‚º", "åœ°çƒä¹‹è…", "åœ°çƒä¹‹å¿ƒ", "åœ°çƒä¹‹çœ¼"], a: 0 }, { t: "ç ä¼æ£®æ—å¾Œç¨®æ¤å–®ä¸€ä½œç‰©(å¦‚æ²¹æ£•)ï¼Œæœƒå°è‡´ï¼Ÿ", o: ["ç”Ÿç‰©å¤šæ¨£æ€§é™ä½", "ç”Ÿæ…‹æ›´è±å¯Œ", "åœŸå£¤æ›´è‚¥æ²ƒ", "å‹•ç‰©æ›´å¿«æ¨‚"], a: 0 }, { t: "æ£®æ—æ¶ˆå¤±å°æ°´å¾ªç’°çš„å½±éŸ¿ï¼Ÿ", o: ["é™é›¨èª¿ç¯€èƒ½åŠ›è®Šå·®", "é›¨æ°´è®Šå¤š", "æ²³æ°´è®Šæ¸…æ¾ˆ", "æ²’æœ‰å½±éŸ¿"], a: 0 }] },
        { name: "å·¥æ¥­æ±¡æŸ“", type: "D", used: [], q: [{ t: "å·¥å» å»¢æ°´ç›´æ¥æ’å…¥æ²³å·æœƒå°è‡´ï¼Ÿ", o: ["å„ªé¤ŠåŒ–èˆ‡ç”Ÿç‰©æ­»äº¡", "æ²³æ°´è®Šå¥½å–", "é­šé¡é•·å¾—æ›´å¤§", "å¢åŠ ç¤¦ç‰©è³ª"], a: 0 }, { t: "ã€Œç”Ÿç‰©æ”¾å¤§ä½œç”¨ã€æ˜¯æŒ‡é‡é‡‘å±¬åœ¨å“ªå€‹éšå±¤æ¿ƒåº¦æœ€é«˜ï¼Ÿ", o: ["é«˜ç´šæ¶ˆè²»è€…(å¦‚äººé¡)", "ç”Ÿç”¢è€…(è—»é¡)", "åˆç´šæ¶ˆè²»è€…(å°è¦)", "æ²³æ°´æœ¬èº«"], a: 0 }, { t: "ç‡ƒç‡’ç…¤ç‚­ç”¢ç”Ÿçš„ç¡«æ°§åŒ–ç‰©æœƒé€ æˆï¼Ÿ", o: ["é…¸é›¨", "å½©è™¹", "åœ°éœ‡", "æµ·å˜¯"], a: 0 }, { t: "PM2.5 æ˜¯æŒ‡ä»€éº¼ï¼Ÿ", o: ["ç´°æ‡¸æµ®å¾®ç²’", "ä¸‹åˆ2é»åŠ", "ä¸€ç¨®ç¶­ç”Ÿç´ ", "æ–°å‹æ©Ÿå™¨äºº"], a: 0 }, { t: "è™•ç†å·¥æ¥­å»¢æ°´çš„æ­£ç¢ºæ–¹å¼ï¼Ÿ", o: ["ç¶“éæ±¡æ°´è™•ç†å» æ·¨åŒ–", "è¶åŠå¤œå·æ’", "åŠ æ°´ç¨€é‡‹å°±å¥½", "æ’å…¥åœ°ä¸‹æ°´"], a: 0 }] },
        { name: "å¤–ä¾†ç¨®å…¥ä¾µ", type: "D", used: [], q: [{ t: "å¤–ä¾†ç¨®ä¹‹æ‰€ä»¥æœƒæ°¾æ¿«ï¼Œé€šå¸¸æ˜¯å› ç‚ºï¼Ÿ", o: ["ç¼ºä¹å¤©æ•µ", "é©æ‡‰åŠ›å·®", "é•·å¾—å¯æ„›", "å£½å‘½å¾ˆçŸ­"], a: 0 }, { t: "åœ¨å°ç£ï¼Œå“ªç¨®ç”Ÿç‰©æ˜¯è‘—åçš„å¤–ä¾†å…¥ä¾µç¨®ï¼Ÿ", o: ["ç¦å£½èº", "å°ç£é»‘ç†Š", "æ«»èŠ±é‰¤å»é®­", "å°ç£è—éµ²"], a: 0 }, { t: "éš¨æ„æ”¾ç”Ÿå¯µç‰©(å¦‚å·´è¥¿é¾œ)æœƒé€ æˆï¼Ÿ", o: ["ç ´å£æœ¬åœŸç”Ÿæ…‹", "å¢åŠ ç”Ÿç‰©å¤šæ¨£æ€§", "è®“çƒé¾œæ›´è‡ªç”±", "æ”¹å–„æ°´è³ª"], a: 0 }, { t: "ã€Œå°èŠ±è”“æ¾¤è˜­ã€è¢«ç¨±ç‚ºä»€éº¼ï¼Ÿ", o: ["ç¶ è‰²æ®ºæ‰‹", "æ£®æ—å…¬ä¸»", "ç¶ è‰²å¯¶çŸ³", "çˆ¬è—¤å°ˆå®¶"], a: 0 }, { t: "é˜²æ²»å¤–ä¾†ç¨®æœ€æœ‰æ•ˆçš„æ–¹æ³•æ˜¯ï¼Ÿ", o: ["æºé ­ç®¡åˆ¶ä¸éš¨æ„å¼•å…¥", "å¤§é‡å™´ç‘è¾²è—¥", "è¨“ç·´æœ¬åœŸç”Ÿç‰©æˆ°é¬¥", "ä¸ç†æœƒ"], a: 0 }] },
        { name: "æ°£å€™è®Šé·", type: "D", used: [], q: [{ t: "é€ æˆå…¨çƒæš–åŒ–çš„ä¸»è¦æº«å®¤æ°£é«”æ˜¯ï¼Ÿ", o: ["CO2 (äºŒæ°§åŒ–ç¢³)", "O2 (æ°§æ°£)", "N2 (æ°®æ°£)", "He (æ°¦æ°£)"], a: 0 }, { t: "æ°£å€™è®Šé·å°è‡´æ¥µåœ°å†°èï¼Œå“ªç¨®å‹•ç‰©å—å®³æœ€æ·±ï¼Ÿ", o: ["åŒ—æ¥µç†Š", "é§±é§", "ç…å­", "ç„¡å°¾ç†Š"], a: 0 }, { t: "æµ·æ°´æº«åº¦ä¸Šå‡æœƒå°è‡´çŠç‘šç”¢ç”Ÿä»€éº¼ç¾è±¡ï¼Ÿ", o: ["ç™½åŒ–", "ç´…åŒ–", "è®Šç¡¬", "ç™¼å…‰"], a: 0 }, { t: "æ¥µç«¯æ°£å€™ä¸åŒ…å«ä¸‹åˆ—ä½•è€…ï¼Ÿ", o: ["æ¯å¤©æº–æ™‚ä¸‹é›¨", "è¶…å¼·é¢±é¢¨", "é•·æœŸä¹¾æ—±", "ç•°å¸¸ç†±æµª"], a: 0 }, { t: "æ¸›ç·©æ°£å€™è®Šé·æˆ‘å€‘å¯ä»¥åšä»€éº¼ï¼Ÿ", o: ["ç¯€èƒ½æ¸›ç¢³", "24å°æ™‚é–‹å†·æ°£", "å¤šåƒç‰›è‚‰", "ç ä¼æ¨¹æœ¨"], a: 0 }] },
        { name: "æ£²åœ°å¾©è‚²", type: "C", used: [], q: [{ t: "å¾©è‚²æ£®æ—æ™‚ï¼Œæœ€å¥½ç¨®æ¤ï¼Ÿ", o: ["åŸç”Ÿç¨®æ¤ç‰©", "å¤–ä¾†ç¨®è§€è³èŠ±", "å–®ä¸€æ¨¹ç¨®", "å¡‘è† æ¨¹"], a: 0 }, { t: "ã€Œç”Ÿæ…‹å»Šé“ã€çš„åŠŸèƒ½æ˜¯ï¼Ÿ", o: ["é€£çµç ´ç¢æ£²åœ°å¹«åŠ©å‹•ç‰©é·å¾™", "çµ¦äººé¡æ•£æ­¥", "è£é£¾é«˜é€Ÿå…¬è·¯", "é˜²æ­¢å™ªéŸ³"], a: 0 }, { t: "æ¿•åœ°å¾©è‚²çš„ä¸»è¦å¥½è™•ä¸åŒ…å«ï¼Ÿ", o: ["å¢åŠ èšŠèŸ²", "æ·¨åŒ–æ°´è³ª", "æä¾›é³¥é¡æ£²æ¯", "é˜²æ´ª"], a: 0 }, { t: "å¾©è‚²è¢ç«èŸ²éœ€è¦ä»€éº¼æ¨£çš„ç’°å¢ƒï¼Ÿ", o: ["ä¹¾æ·¨ç„¡å…‰å®³çš„æ°´åŸŸ", "ç†±é¬§çš„å…¬åœ’", "å……æ»¿è¾²è—¥çš„ç”°", "è·¯ç‡ˆä¸‹"], a: 0 }, { t: "äººå·¥é­šç¤çš„åŠŸèƒ½æ˜¯ï¼Ÿ", o: ["æä¾›é­šé¡èº²è—èˆ‡æ£²æ¯", "ä¸Ÿæ£„å»¢æ£„ç‰©", "é˜»æ“‹èˆ¹éš»", "ç¾è§€"], a: 0 }] },
        { name: "è³‡æºå›æ”¶", type: "C", used: [], q: [{ t: "å“ªç¨®æ¨™èªŒä»£è¡¨è³‡æºå›æ”¶ï¼Ÿ", o: ["ä¸‰å€‹å¾ªç’°ç®­é ­", "ç´…è‰²åå­—", "é»ƒè‰²é–ƒé›»", "ç¶ è‰²æ„›å¿ƒ"], a: 0 }, { t: "æ¸…æ´—å›æ”¶ç‰©çš„ä¸»è¦ç›®çš„æ˜¯ï¼Ÿ", o: ["é¿å…ç™¼è‡­èˆ‡å­³ç”ŸèšŠèŸ²", "è®“å›æ”¶é˜¿å§¨é–‹å¿ƒ", "å¢åŠ é‡é‡", "å¹«åƒåœ¾æ´—æ¾¡"], a: 0 }, { t: "å»¢é›»æ± æ‡‰è©²å¦‚ä½•è™•ç†ï¼Ÿ", o: ["å›æ”¶è‡³å°ˆå±¬å›æ”¶ç­’", "ä¸Ÿä¸€èˆ¬åƒåœ¾", "åŸ‹åœ¨åœŸè£¡", "ç‡’æ‰"], a: 0 }, { t: "å»šé¤˜å›æ”¶å¯ä»¥ç”¨ä¾†åšä»€éº¼ï¼Ÿ", o: ["å †è‚¥æˆ–é¤Šè±¬", "åšæˆé¤…ä¹¾", "é‹ªè·¯", "è“‹æˆ¿å­"], a: 0 }, { t: "æ¸›å°‘ä½¿ç”¨å¡‘è† å¸ç®¡æ˜¯ç‚ºäº†ä¿è­·å“ªç¨®å‹•ç‰©ï¼Ÿ", o: ["æµ·é¾œ", "è€é·¹", "èš¯èš“", "æ¾é¼ "], a: 0 }] },
        { name: "å†ç”Ÿèƒ½æº", type: "C", used: [], q: [{ t: "ä¸‹åˆ—ä½•è€…å±¬æ–¼å†ç”Ÿèƒ½æºï¼Ÿ", o: ["å¤ªé™½èƒ½", "ç…¤ç‚­", "çŸ³æ²¹", "å¤©ç„¶æ°£"], a: 0 }, { t: "å°ç£è¥¿éƒ¨æ²¿æµ·å¸¸è¦‹çš„ç™½è‰²å·¨å¤§é¢¨æ‰‡æ˜¯ï¼Ÿ", o: ["é¢¨åŠ›ç™¼é›»æ©Ÿ", "è¶…å¤§é›»é¢¨æ‰‡", "è£ç½®è—è¡“", "è¶•é³¥å™¨"], a: 0 }, { t: "ä½¿ç”¨å†ç”Ÿèƒ½æºçš„æœ€å¤§å„ªé»ï¼Ÿ", o: ["æ¸›å°‘ç¢³æ’æ”¾", "å®Œå…¨ä¸èŠ±éŒ¢", "è£½é€ æ›´å¤šåƒåœ¾", "éš¨æ™‚éƒ½æœ‰é›»"], a: 0 }, { t: "ç”Ÿè³ªèƒ½é€šå¸¸ä¾†è‡ªï¼Ÿ", o: ["å‹•æ¤ç‰©æœ‰æ©Ÿå»¢æ£„ç‰©", "çŸ³é ­", "é‡‘å±¬", "ç»ç’ƒ"], a: 0 }, { t: "åœ°ç†±ç™¼é›»æ˜¯åˆ©ç”¨åœ°çƒå…§éƒ¨çš„ä»€éº¼ï¼Ÿ", o: ["ç†±èƒ½", "ç£åŠ›", "é‡åŠ›", "æ—‹è½‰"], a: 0 }] },
        { name: "ç”Ÿç‰©å¤šæ¨£æ€§", type: "C", used: [], q: [{ t: "ç”Ÿç‰©å¤šæ¨£æ€§é«˜çš„å¥½è™•æ˜¯ï¼Ÿ", o: ["ç”Ÿæ…‹ç³»çµ±è¼ƒç©©å®š", "ç’°å¢ƒæ¯”è¼ƒé«’äº‚", "å‹•ç‰©å®¹æ˜“æ‰“æ¶", "æ²’æœ‰å¥½è™•"], a: 0 }, { t: "å°ç£ç‰¹æœ‰ç¨®ã€ŒçŸ³è™ã€é¢è‡¨çš„æœ€å¤§å±æ©Ÿï¼Ÿ", o: ["è·¯æ®ºèˆ‡æ£²åœ°å–ªå¤±", "è¢«æŠ“å»å‹•ç‰©åœ’", "é£Ÿç‰©å¤ªå¤š", "å¤©æ°£å¤ªç†±"], a: 0 }, { t: "ä¿è­·èœœèœ‚ç‚ºä»€éº¼å¾ˆé‡è¦ï¼Ÿ", o: ["å¹«å¿™è¾²ä½œç‰©æˆç²‰", "å¯ä»¥åƒèœ‚èœœ", "èœœèœ‚å¾ˆå¯æ„›", "é‡å¯ä»¥ç”¨ä¾†é‡ç¸"], a: 0 }, { t: "ä¸‹åˆ—å“ªå€‹åœ°æ–¹çš„ç”Ÿç‰©å¤šæ¨£æ€§é€šå¸¸æœ€é«˜ï¼Ÿ", o: ["ç†±å¸¶é›¨æ—", "æ²™æ¼ ", "åŒ—æ¥µ", "æ°´æ³¥åŸå¸‚"], a: 0 }, { t: "åŸºå› å¤šæ¨£æ€§é«˜ä»£è¡¨ï¼Ÿ", o: ["ç‰©ç¨®è¼ƒèƒ½æŠµæŠ—ç–¾ç—…", "ç‰©ç¨®å®¹æ˜“æ»…çµ•", "å¤§å®¶é•·å¾—ä¸€æ¨¡ä¸€æ¨£", "å®¹æ˜“ç”Ÿç—…"], a: 0 }] },
        { name: "æ°´è³‡æºä¿è­·", type: "C", used: [], q: [{ t: "æ´—ç±³æ°´å¯ä»¥ç”¨ä¾†ï¼Ÿ", o: ["æ¾†èŠ±", "æ´—è»Š", "æ´—æ¾¡", "ç›´æ¥å€’æ‰"], a: 0 }, { t: "å°ç£é›–ç„¶é›¨é‡å¤šï¼Œå»ç¼ºæ°´çš„åŸå› ï¼Ÿ", o: ["åœ°å‹¢é™¡å³­æ°´æµå¿«", "å¤§å®¶ä¸æ„›å–æ°´", "è’¸ç™¼å¤ªå¿«", "æ°´è¢«å·èµ°äº†"], a: 0 }, { t: "é¸è³¼æ´—è¡£æ©Ÿæ™‚ï¼Œæ‡‰èªæ˜ä»€éº¼æ¨™ç« ï¼Ÿ", o: ["çœæ°´æ¨™ç« ", "å„ªè‰¯é£Ÿå“", "æ­£å­—æ¨™è¨˜", "CAS"], a: 0 }, { t: "ä¿è­·æ²³å·ä¸Šæ¸¸æ£®æ—çš„ä¸»è¦åŠŸèƒ½ï¼Ÿ", o: ["æ¶µé¤Šæ°´æº", "ç¨®é«˜å±±é«˜éº—èœ", "è“‹è±ªè¯æ°‘å®¿", "å€’åƒåœ¾"], a: 0 }, { t: "ç”Ÿæ´»æ±¡æ°´ä¸­ï¼Œå“ªç¨®æ±è¥¿æœ€å®¹æ˜“æ±¡æŸ“æ°´æºï¼Ÿ", o: ["å«ç£·æ¸…æ½”åŠ‘", "æ´—ç±³æ°´", "èŒ¶è‘‰æ¸£", "æœçš®"], a: 0 }] }
    ];

    window.onload = function() {
        const checkReady = setInterval(() => {
            if (typeof AFRAME !== 'undefined' && document.querySelector('a-scene').hasLoaded) {
                clearInterval(checkReady);
                document.getElementById('init-btn').innerText = "é»æ“Šé–‹å•Ÿ";
                document.getElementById('init-btn').disabled = false;
                document.getElementById('init-btn').style.background = "#4CAF50";
                document.getElementById('init-btn').style.color = "white";
                
                document.getElementById('init-btn').onclick = () => {
                    document.getElementById('home-screen').style.display = 'none';
                    document.getElementById('team-select-modal').style.display = 'flex';
                };
            }
        }, 500);
    };

    function toggleInstructions(show) {
        document.getElementById('instruction-modal').style.display = show ? 'block' : 'none';
    }

    // --- æŒ‰éˆ•åŠŸèƒ½ ---
    function manualNextTurn() {
        if (confirm("ç¢ºå®šè¦å¼·åˆ¶æ›äººå—ï¼Ÿ")) {
            // å¦‚æœå½±ç‰‡æ­£åœ¨æ’­æ”¾ï¼Œæš«åœå®ƒ
            for(let i=0; i<10; i++) {
                const v = document.getElementById(`v${i}`);
                if(v && !v.paused) v.pause();
            }
            // éš±è—å¯èƒ½å‡ºç¾çš„å¤§å­—å¡æˆ–é¡Œç›®
            document.getElementById('theme-toast').style.display = 'none';
            document.getElementById('quiz-box').style.display = 'none';
            document.getElementById('result-msg').style.display = 'none';
            
            nextTurn();
        }
    }

    function toggleNaturalSelection() {
        isNaturalSelection = !isNaturalSelection;
        const btn = document.getElementById('btn-natural');
        const status = document.getElementById('ns-status');
        
        if (isNaturalSelection) {
            btn.classList.add('active');
            status.innerText = "ON";
        } else {
            btn.classList.remove('active');
            status.innerText = "OFF";
        }
    }

    async function startGame(team) {
        currentTurn = team;
        updateTurnUI();
        const sceneEl = document.querySelector('a-scene');
        try {
            await sceneEl.systems["mindar-image-system"].start();
            document.getElementById('team-select-modal').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            bindMarkers();
        } catch (e) {
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªä½¿ç”¨ HTTPS åŠæ¬Šé™");
        }
    }

    function updateTurnUI() {
        const banner = document.getElementById('turn-banner');
        if (currentTurn === 'blue') {
            banner.innerText = "ç¾åœ¨å›åˆï¼šè—æ–¹ (BLUE)";
            banner.style.background = "#4b6cb7";
            banner.style.border = "3px solid #89a5e6";
        } else {
            banner.innerText = "ç¾åœ¨å›åˆï¼šç´…æ–¹ (RED)";
            banner.style.background = "#D31027";
            banner.style.border = "3px solid #ff8a95";
        }
    }

    function bindMarkers() {
        for (let i = 0; i < 10; i++) {
            const m = document.getElementById(`marker${i}`);
            m.addEventListener("targetFound", () => handleScan(i));
            m.addEventListener("targetLost", () => {
                const v = document.getElementById(`v${i}`);
                if(v) v.pause();
            });
        }
    }

    function handleScan(index) {
        if (isLocked || isGameOver) return;
        
        const video = document.getElementById(`v${index}`);
        video.play();
        
        const card = quizDatabase[index];
        const toast = document.getElementById('theme-toast');
        
        // å¤©æ“‡æ¨¡å¼é¡¯ç¤ºèª¿æ•´
        if (isNaturalSelection) {
            toast.innerHTML = "âš¡ " + card.name + " âš¡<br><span style='font-size:24px'>å¤©æ“‡é™è‡¨ï¼šç ´å£å¡æ•ˆæœ x2</span>";
            toast.style.color = "#FF512F";
            toast.style.border = "3px solid #FF512F";
        } else {
            toast.innerText = card.name;
            toast.style.color = "#FFD700";
            toast.style.border = "3px solid #FFD700";
        }

        toast.style.display = 'block';
        toast.style.animation = 'none';
        toast.offsetHeight;
        toast.style.animation = 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

        setTimeout(() => {
            if (!isLocked && !isGameOver) {
                isLocked = true;
                video.pause();
                toast.style.display = 'none';
                showQuestion(index);
            }
        }, 5000);
    }

    function showQuestion(cardIndex) {
        const card = quizDatabase[cardIndex];
        let availableIndices = card.q.map((_, i) => i).filter(i => !card.used.includes(i));
        
        if (availableIndices.length === 0) {
            card.used = [];
            availableIndices = card.q.map((_, i) => i);
        }

        const qIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        card.used.push(qIndex);
        const qData = card.q[qIndex];

        let optionsMap = qData.o.map((txt, idx) => ({ txt, isCorrect: idx === 0 }));
        optionsMap.sort(() => Math.random() - 0.5);

        document.getElementById('quiz-box').style.display = 'block';
        
        // UI é¡¯ç¤ºèª¿æ•´
        let displayType = card.type;
        if (isNaturalSelection) {
            displayType = 'D'; // å¼·åˆ¶è¦–ç‚ºç ´å£å¡
            document.getElementById('q-category').innerText = "ã€å¤©æ“‡æ¨¡å¼ï¼šå¼·åˆ¶ç ´å£å¡ã€‘";
            document.getElementById('q-category').style.color = "#FF0000";
        } else {
            document.getElementById('q-category').innerText = card.type === 'D' ? "ã€ç ´å£å¡ã€‘" : "ã€ä¿è‚²å¡ã€‘";
            document.getElementById('q-category').style.color = card.type === 'D' ? "#D31027" : "#4CAF50";
        }
        
        document.getElementById('q-title').innerText = card.name;
        document.getElementById('q-text').innerText = qData.t;

        const optArea = document.getElementById('q-options');
        optArea.innerHTML = '';
        
        optionsMap.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.txt;
            btn.onclick = () => handleAnswer(opt.isCorrect, card.type); // å‚³å…¥åŸå§‹é¡å‹ï¼Œå…§éƒ¨å†è™•ç† override
            optArea.appendChild(btn);
        });
    }

    function handleAnswer(isCorrect, originalType) {
        document.getElementById('quiz-box').style.display = 'none';
        
        let title = "", scoreText = "", detail = "";
        
        // æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœæ˜¯å¤©æ“‡æ¨¡å¼ï¼Œå¼·åˆ¶é¡å‹ç‚º 'D' ä¸”å€ç‡ç‚º 2
        let effectiveType = isNaturalSelection ? 'D' : originalType;
        let multiplier = isNaturalSelection ? 2 : 1;
        let points = 10 * multiplier;

        if (effectiveType === 'D') {
            // ç ´å£å¡é‚è¼¯ï¼šç­”å°æ‰£æ•µæ–¹ï¼Œç­”éŒ¯æ‰£å·±æ–¹
            if (isCorrect) {
                title = isNaturalSelection ? "âš¡ å¤©æ“‡æ”»æ“Šï¼" : "ğŸ‰ æ”»æ“ŠæˆåŠŸï¼";
                if (currentTurn === 'blue') {
                    scores.red -= points;
                    detail = `è—æ–¹æˆåŠŸç™¼å‹•æ”»å‹¢ï¼Œç´…æ–¹ -${points} åˆ†`;
                } else {
                    scores.blue -= points;
                    detail = `ç´…æ–¹æˆåŠŸç™¼å‹•æ”»å‹¢ï¼Œè—æ–¹ -${points} åˆ†`;
                }
                scoreText = `æ•µæ–¹ -${points}`;
            } else {
                title = isNaturalSelection ? "âš¡ å¤©æ“‡åå™¬ï¼" : "ğŸ’¥ è‡ªé£Ÿæƒ¡æœï¼";
                if (currentTurn === 'blue') {
                    scores.blue -= points;
                    detail = `è—æ–¹è§€å¿µéŒ¯èª¤ï¼Œåå—å‚·å®³ -${points} åˆ†`;
                } else {
                    scores.red -= points;
                    detail = `ç´…æ–¹è§€å¿µéŒ¯èª¤ï¼Œåå—å‚·å®³ -${points} åˆ†`;
                }
                scoreText = `å·±æ–¹ -${points}`;
            }
        } 
        else {
            // ä¿è‚²å¡é‚è¼¯ (åªæœƒåœ¨éå¤©æ“‡æ¨¡å¼ä¸‹ç™¼ç”Ÿ)
            if (isCorrect) {
                title = "ğŸŒ¿ ä¿è‚²æˆåŠŸï¼";
                if (currentTurn === 'blue') scores.blue += points;
                else scores.red += points;
                detail = "ç’°å¢ƒè®Šå¾—æ›´å¥½äº†ï¼";
                scoreText = `å·±æ–¹ +${points}`;
            } else {
                title = "ğŸ’¨ éŒ¯å¤±è‰¯æ©Ÿ";
                detail = "å¯æƒœç­”éŒ¯äº†ï¼Œæ²’æœ‰åŠ åˆ†ã€‚";
                scoreText = "+0";
            }
        }

        document.getElementById('score-blue').innerText = scores.blue;
        document.getElementById('score-red').innerText = scores.red;

        const resDiv = document.getElementById('result-msg');
        resDiv.style.display = 'flex';
        
        if (scores.blue >= 50 || scores.red >= 50) {
            isGameOver = true;
            let winner = scores.blue >= 50 ? "è—æ–¹ (BLUE)" : "ç´…æ–¹ (RED)";
            document.getElementById('res-title').innerText = "ğŸ† éŠæˆ²çµæŸï¼";
            document.getElementById('res-score').innerText = `ç²å‹è€…ï¼š${winner}`;
            document.getElementById('res-detail').innerText = `æ­å–œ ${winner} ç‡å…ˆé”æˆ 50 åˆ†ç›®æ¨™ï¼`;
            const btn = document.getElementById('res-btn');
            btn.innerText = "é‡æ–°é–‹å§‹";
            btn.onclick = () => location.reload();
        } else {
            document.getElementById('res-title').innerText = title;
            document.getElementById('res-score').innerText = scoreText;
            document.getElementById('res-detail').innerText = detail;
            const btn = document.getElementById('res-btn');
            btn.innerText = "æ›å°æ–¹å›åˆ";
            btn.onclick = nextTurn;
        }
    }

    function nextTurn() {
        document.getElementById('result-msg').style.display = 'none';
        
        // æ›äººå¾Œè‡ªå‹•é—œé–‰å¤©æ“‡æ¨¡å¼ï¼Œç¢ºä¿å…¬å¹³èˆ‡å®‰å…¨
        if (isNaturalSelection) {
            toggleNaturalSelection();
        }

        currentTurn = (currentTurn === 'blue') ? 'red' : 'blue';
        updateTurnUI();
        isLocked = false;
    }
</script>
</body>
</html>