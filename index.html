<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARç”Ÿæ…‹æ¢éšªï¼šç’°å¢ƒä¿è‚²æ•™è‚²æ¡ŒéŠç³»çµ±</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; background-color: #000; }
        
        /* é¦–é æ¨£å¼ */
        #home-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; color: white; text-align: center;
        }
        .menu-btn {
            background: #4CAF50; color: white; padding: 15px 40px; border: none;
            border-radius: 30px; font-size: 20px; cursor: pointer; margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .menu-btn:active { transform: scale(0.95); }
        .menu-btn:disabled { background: #cccccc !important; cursor: not-allowed; transform: none; }

        /* éŠæˆ²èªªæ˜å½ˆçª— */
        #instruction-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 400px; background: white; color: #333;
            padding: 20px; border-radius: 15px; display: none; z-index: 3000;
        }

        /* éŠæˆ² UI */
        #ui-layer { position: fixed; top: 10px; left: 10px; z-index: 1000; background: rgba(0,0,0,0.8); color: white; padding: 12px; border-radius: 8px; display: none; }
        #quiz-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; background: white; padding: 25px; border-radius: 15px; display: none; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .ans-btn { background: #2c3e50; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; margin: 8px 0; width: 100%; font-size: 16px; }
        #result-msg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; z-index: 1002; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div id="home-screen">
    <h1 style="font-size: 2.5em; margin-bottom: 10px;">AR ç”Ÿæ…‹æ¢éšª</h1>
    <p style="margin-bottom: 40px; opacity: 0.9;">ç’°å¢ƒä¿è‚²æ•™è‚²æ¡ŒéŠç³»çµ±</p>
    <button class="menu-btn" onclick="toggleInstructions(true)">éŠæˆ²èªªæ˜</button>
    <button id="start-btn" class="menu-btn" style="background: #2196F3;" disabled>éŠæˆ²é–‹å§‹</button>
    <p id="status-msg" style="margin-top: 20px; font-size: 12px; opacity: 0.7;">ç³»çµ±è¼‰å…¥ä¸­...</p>
</div>

<div id="instruction-modal">
    <h3>ğŸ“– éŠæˆ²èªªæ˜</h3>
    <p style="text-align: left; line-height: 1.6;">
        1. æœ¬éŠæˆ²éœ€é…åˆ 10 å¼µå°ˆå±¬ç”Ÿæ…‹å¡ç‰Œã€‚<br>
        2. æƒæ<b>ç ´å£å¡</b>ï¼šç­”å°æ‰£å°æ‰‹ 10 åˆ†ï¼Œç­”éŒ¯æ‰£è‡ªå·± 10 åˆ†ã€‚<br>
        3. æƒæ<b>ä¿è‚²å¡</b>ï¼šç­”å°è‡ªå·±åŠ  10 åˆ†ï¼Œç­”éŒ¯ä¸åŠ åˆ†ã€‚<br>
        4. è«‹ç¢ºä¿åœ¨å…‰ç·šå……è¶³è™•é€²è¡Œæƒæã€‚
    </p>
    <button class="ans-btn" onclick="toggleInstructions(false)">æˆ‘çŸ¥é“äº†</button>
</div>

<div id="ui-layer">
    <div style="color:#4CAF50">æˆ‘çš„åˆ†æ•¸ï¼š<span id="score-me">0</span></div>
    <div style="color:#FF5252">å°æ‰‹åˆ†æ•¸ï¼š<span id="score-opp">0</span></div>
</div>

<div id="quiz-box">
    <h3 id="card-title" style="margin-top:0; color:#2c3e50"></h3>
    <p id="question-text" style="color:#333; line-height:1.6"></p>
    <div id="options-area"></div>
</div>

<div id="result-msg">
    <h2 id="feedback-title"></h2>
    <p id="feedback-body"></p>
    <button class="ans-btn" style="width:150px" onclick="closeFeedback()">ç¹¼çºŒ</button>
</div>

<a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; filterMinCF:0.001; filterBeta:0.01;" 
         color-space="sRGB" 
         renderer="colorManagement: true, physicallyCorrectLights" 
         vr-mode-ui="enabled: false" 
         device-orientation-permission-ui="enabled: false">
    
    <a-assets>
        <video id="v0" src="./videos/v0.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v1" src="./videos/v1.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v2" src="./videos/v2.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v3" src="./videos/v3.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v4" src="./videos/v4.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v5" src="./videos/v5.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v6" src="./videos/v6.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v7" src="./videos/v7.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v8" src="./videos/v8.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
        <video id="v9" src="./videos/v9.mp4" playsinline webkit-playsinline muted crossorigin="anonymous" loop="false"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <script>
        const scene = document.querySelector('a-scene');
        for (let i = 0; i < 10; i++) {
            const target = document.createElement('a-entity');
            target.setAttribute('mindar-image-target', `targetIndex: ${i}`);
            target.id = `marker${i}`;
            const videoPlane = document.createElement('a-video');
            videoPlane.setAttribute('src', `#v${i}`);
            videoPlane.setAttribute('width', '1');
            videoPlane.setAttribute('height', '0.75');
            videoPlane.setAttribute('position', '0 0 0');
            target.appendChild(videoPlane);
            scene.appendChild(target);
        }
    </script>
</a-scene>

<script>
    let myScore = 0, oppScore = 0, isLocked = false;
    let isSystemReady = false;

    // æª¢æŸ¥ç³»çµ±æ˜¯å¦æº–å‚™å°±ç·’
    function checkSystemReady() {
        const statusMsg = document.getElementById('status-msg');
        const startBtn = document.getElementById('start-btn');
        
        // ä¿®æ­£é‡é» 3: AFRAME è¼‰å…¥æª¢æŸ¥
        if (typeof AFRAME !== 'undefined' && document.querySelector('a-scene').hasLoaded) {
            isSystemReady = true;
            statusMsg.innerText = "ç³»çµ±å·²å°±ç·’ï¼Œè«‹é»æ“Šé–‹å§‹";
            startBtn.disabled = false;
            console.log("ç³»çµ±å°±ç·’æª¢æŸ¥å®Œæˆ");
        } else {
            // å¦‚æœé‚„æ²’å°±ç·’ï¼Œå»¶é²æª¢æŸ¥
            setTimeout(checkSystemReady, 500);
        }
    }

    // ç•¶é é¢å®Œå…¨è¼‰å…¥å¾Œé–‹å§‹æª¢æŸ¥
    window.addEventListener('load', function() {
        console.log("é é¢å·²è¼‰å…¥");
        checkSystemReady();
        
        // ç¶å®šé–‹å§‹æŒ‰éˆ•
        document.getElementById('start-btn').addEventListener('click', startGame);
    });

    // æ ¸å¿ƒå•Ÿå‹•å‡½æ•¸
    async function startGame() {
        if (!isSystemReady) {
            alert("ç³»çµ±å°šæœªæº–å‚™å®Œæˆï¼Œè«‹ç¨å€™å†è©¦");
            return;
        }

        const statusMsg = document.getElementById('status-msg');
        const startBtn = document.getElementById('start-btn');
        
        statusMsg.innerText = "æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹å…è¨±æ¬Šé™...";
        startBtn.disabled = true;

        const sceneEl = document.querySelector('a-scene');
        
        try {
            await sceneEl.systems["mindar-image-system"].start();
            console.log("AR å•Ÿå‹•æˆåŠŸ");
            
            // æˆåŠŸå¾Œåˆ‡æ› UI
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            
        } catch (error) {
            console.error("AR å•Ÿå‹•å¤±æ•—:", error);
            alert("ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼è«‹ç¢ºèªï¼š\n1. ç¶²å€é–‹é ­æ˜¯ https\n2. ä½¿ç”¨ Safari(iOS) æˆ– Chrome(Android)\n3. å·²å…è¨±ç›¸æ©Ÿæ¬Šé™");
            statusMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†";
            startBtn.disabled = false;
        }
    }

    // ç›£è½æƒæé‚è¼¯
    function setupMarkerListeners() {
        for (let i = 0; i < 10; i++) {
            const marker = document.getElementById(`marker${i}`);
            if (marker) {
                marker.addEventListener("targetFound", () => {
                    if (!isLocked) {
                        const video = document.getElementById(`v${i}`);
                        if (video) {
                            video.play().catch(e => console.error("å½±ç‰‡æ’­æ”¾å¤±æ•—:", e));
                            // 5ç§’å¾Œå‡ºé¡Œ
                            setTimeout(() => { 
                                if(!isLocked) {
                                    video.pause();
                                    startQuiz(i); 
                                }
                            }, 5000);
                        }
                    }
                });
                marker.addEventListener("targetLost", () => { 
                    const video = document.getElementById(`v${i}`);
                    if (video) video.pause(); 
                });
            }
        }
    }

    // ç¢ºä¿å ´æ™¯è¼‰å…¥å¾Œç¶å®šç›£è½å™¨
    const sceneEl = document.querySelector('a-scene');
    if (sceneEl.hasLoaded) {
        setupMarkerListeners();
    } else {
        sceneEl.addEventListener('loaded', setupMarkerListeners);
    }

    const quizData = [
        { name: "éåº¦æ•æ’ˆ", type: "D", q: ["åº•æ‹–ç¶²æœƒç ´å£æµ·åº•æ£²åœ°å—ï¼Ÿ", "æ•ç²å¹¼é­šæœƒå°è‡´æ—ç¾¤æ¯ç«­å—ï¼Ÿ", "é­šé¡æ¸›å°‘æœƒç ´å£é£Ÿç‰©éˆå—ï¼Ÿ"] },
        { name: "æ¿«ç æ¿«ä¼", type: "D", q: ["æ£®æ—æ¶ˆå¤±æœƒå¢åŠ äºŒæ°§åŒ–ç¢³å—ï¼Ÿ", "æ¨¹æœ¨èƒ½é˜²æ­¢åœŸçŸ³æµå—ï¼Ÿ", "ä¼æœ¨æœƒå°è‡´ç”Ÿç‰©å¤±å»å®¶åœ’å—ï¼Ÿ"] },
        { name: "å·¥æ¥­æ±¡æŸ“", type: "D", q: ["å»¢æ°´æ’å…¥æ²³ä¸­æœƒæ®ºæ­»é­šé¡å—ï¼Ÿ", "é‡é‡‘å±¬æœƒç¶“é£Ÿç‰©éˆç´¯ç©å—ï¼Ÿ", "æ±¡æŸ“æœƒå°è‡´æ°´æºç„¡æ³•é£²ç”¨å—ï¼Ÿ"] },
        { name: "å¤–ä¾†ç¨®å…¥ä¾µ", type: "D", q: ["å¤–ä¾†ç¨®æœƒæ¶å¥ªæœ¬åœŸç¨®é£Ÿç‰©å—ï¼Ÿ", "å¤–ä¾†ç¨®æœƒå› ç„¡å¤©æ•µéåº¦ç¹æ®–å—ï¼Ÿ", "éš¨æ„æ”¾ç”Ÿæœƒç ´å£å¹³è¡¡å—ï¼Ÿ"] },
        { name: "æ°£å€™è®Šé·", type: "D", q: ["æ°£æº«ä¸Šå‡æœƒå°è‡´å†°å±±èåŒ–å—ï¼Ÿ", "æ¥µç«¯æ°£å€™æœƒå½±éŸ¿ä½œç‰©ç”Ÿé•·å—ï¼Ÿ", "æµ·æ´‹è®Šæš–æœƒå°è‡´çŠç‘šç™½åŒ–å—ï¼Ÿ"] },
        { name: "æ£²åœ°å¾©è‚²", type: "C", q: ["ç¨®æ¤åŸç”Ÿæ¤ç‰©èƒ½æ¢å¾©ç”Ÿæ…‹å—ï¼Ÿ", "å»ºç«‹ç”Ÿæ…‹å»Šé“èƒ½å¹«åŠ©é·å¾™å—ï¼Ÿ", "æ¿•åœ°å¾©è‚²èƒ½éæ¿¾æ°´è³ªå—ï¼Ÿ"] },
        { name: "è³‡æºå›æ”¶", type: "C", q: ["å›æ”¶èƒ½æ¸›å°‘å»¢æ£„ç‰©é€²æµ·æ´‹å—ï¼Ÿ", "æ¸›å°‘å¡‘è† èƒ½ä¿è­·æµ·é¾œå—ï¼Ÿ", "å›æ”¶é‡‘å±¬èƒ½æ¸›å°‘ç¤¦ç”¢é–‹ç™¼å—ï¼Ÿ"] },
        { name: "å†ç”Ÿèƒ½æº", type: "C", q: ["é¢¨åŠ›ç™¼é›»èƒ½æ¸›å°‘ç¢³æ’æ”¾å—ï¼Ÿ", "å¤ªé™½èƒ½æ˜¯æ°¸çºŒçš„èƒ½æºå—ï¼Ÿ", "ç¶ èƒ½èƒ½æ¸›ç·©å…¨çƒæš–åŒ–å—ï¼Ÿ"] },
        { name: "ç”Ÿç‰©å¤šæ¨£æ€§", type: "C", q: ["ç‰©ç¨®è¶Šå¤šç”Ÿæ…‹ç³»çµ±è¶Šç©©å®šå—ï¼Ÿ", "æ¯ç¨®ç‰©ç¨®éƒ½æœ‰å…¶åŠŸèƒ½å—ï¼Ÿ", "å¤šæ¨£æ€§é«˜èƒ½æå‡æŠ—ç—…åŠ›å—ï¼Ÿ"] },
        { name: "æ°´è³‡æºä¿è­·", type: "C", q: ["ç¯€ç´„ç”¨æ°´èƒ½ä¿è­·æ·¡æ°´ç”Ÿæ…‹å—ï¼Ÿ", "æ¸›å°‘åŒ–å­¸æ´—åŠ‘èƒ½ä¿è­·æ°´æºå—ï¼Ÿ", "ä¿è­·æ£®æ—èƒ½æ¶µé¤Šæ°´æºå—ï¼Ÿ"] }
    ];

    function toggleInstructions(show) {
        document.getElementById('instruction-modal').style.display = show ? 'block' : 'none';
    }

    function startQuiz(id) {
        isLocked = true;
        const card = quizData[id];
        const randomQ = card.q[Math.floor(Math.random() * card.q.length)];
        document.getElementById('quiz-box').style.display = 'block';
        document.getElementById('card-title').innerText = card.name;
        document.getElementById('question-text').innerText = randomQ;
        const area = document.getElementById('options-area');
        area.innerHTML = '';
        ["æ˜¯ / å¯ä»¥", "å¦ / ä¸å¯ä»¥"].forEach((txt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'ans-btn';
            btn.innerText = txt;
            btn.onclick = () => checkAns(idx === 0, card.type);
            area.appendChild(btn);
        });
    }

    function checkAns(correct, type) {
        let title = "", body = "";
        if (type === "D") {
            if (correct) { title = "ğŸ‰ ç­”å°äº†ï¼"; body = "å°æ‰‹æ‰£ 10 åˆ†ï¼"; oppScore -= 10; }
            else { title = "âŒ ç­”éŒ¯äº†ï¼"; body = "æ­£ç¢ºç­”æ¡ˆæ˜¯ã€Œæ˜¯ã€ã€‚è‡ªå·±æ‰£ 10 åˆ†"; myScore -= 10; }
        } else {
            if (correct) { title = "ğŸŒ¿ ç­”å°äº†ï¼"; body = "è‡ªå·±åŠ  10 åˆ†ï¼"; myScore += 10; }
            else { title = "âŒ ç­”éŒ¯äº†ï¼"; body = "æ­£ç¢ºç­”æ¡ˆæ˜¯ã€Œæ˜¯ã€"; }
        }
        document.getElementById('score-me').innerText = myScore;
        document.getElementById('score-opp').innerText = oppScore;
        document.getElementById('quiz-box').style.display = 'none';
        document.getElementById('feedback-title').innerText = title;
        document.getElementById('feedback-body').innerText = body;
        document.getElementById('result-msg').style.display = 'flex';
    }

    function closeFeedback() {
        document.getElementById('result-msg').style.display = 'none';
        setTimeout(() => { isLocked = false; }, 3000);
    }
</script>
</body>
</html>